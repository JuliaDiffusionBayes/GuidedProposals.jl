<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>BFFG algorithm · GuidedProposals.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">GuidedProposals.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../get_started/overview/">Get started</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">User manual</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../guid_prop/">Guided proposals</a></li><li><a class="tocitem" href="../multiple_obs/">Multiple observations</a></li><li><a class="tocitem" href="../log_likelihood/">Log-likelihoods</a></li><li><a class="tocitem" href="../reparameterizations/">Reparameterizations</a></li><li class="is-active"><a class="tocitem" href>BFFG algorithm</a><ul class="internal"><li><a class="tocitem" href="#Forward-guide-1"><span>Forward guide</span></a></li><li><a class="tocitem" href="#Backward-filter-1"><span>Backward filter</span></a></li></ul></li><li><a class="tocitem" href="../path_functionals/">Computing path functionals</a></li><li><a class="tocitem" href="../convenience/">Convenience functions</a></li><li><a class="tocitem" href="../ode_type/">ODE systems</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">How to...</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../how_to_guides/sample_bridges/">Sample diffusion bridges</a></li><li><a class="tocitem" href="../../how_to_guides/first_passage_time/">Sample diffusions in first-passage time setting</a></li><li><a class="tocitem" href="../../how_to_guides/smoothing/">Do smoothing</a></li><li><a class="tocitem" href="../../how_to_guides/parameter_inference/">Do parameter inference</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../tutorials/in_place_vs_out_of_place/">Understanding in-place vs out-of-place</a></li><li><a class="tocitem" href="../../tutorials/smoothing/">Smoothing/Imputation</a></li><li><a class="tocitem" href="../../tutorials/parameter_inference/">Parameter inference</a></li></ul></li><li><a class="tocitem" href="../../module_index/">Index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">User manual</a></li><li class="is-active"><a href>BFFG algorithm</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>BFFG algorithm</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaDiffusionBayes/GuidedProposals.jl/blob/master/docs/src/manual/bffg.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Backward-filtering-forward-guiding-algorithm-1"><a class="docs-heading-anchor" href="#Backward-filtering-forward-guiding-algorithm-1">Backward filtering-forward guiding algorithm</a><a class="docs-heading-anchor-permalink" href="#Backward-filtering-forward-guiding-algorithm-1" title="Permalink"></a></h1><p>This package implements a computational framework from <a href="https://arxiv.org/abs/1712.03807">this paper</a> for computing various terms of guided proposals. In particular, we provide high-level routines that correspond to the two main sweeps of the main algorithm:</p><ul><li><code>backward_filter!</code> &amp;</li><li><code>forward_guide!</code>.</li></ul><p>Both of them operate on an already initialized vector of <code>GuidProp</code> that corresponds to a <code>recording</code>.</p><h2 id="Forward-guide-1"><a class="docs-heading-anchor" href="#Forward-guide-1">Forward guide</a><a class="docs-heading-anchor-permalink" href="#Forward-guide-1" title="Permalink"></a></h2><p>The <code>forward_guide!</code> function is used to sample a trajectory of multiple guided proposals stacked together, targeting some conditional diffusion law, that is conditioned on multiple observations.</p><p>Let&#39;s look at the example from the previous section, were we defined guided proposals for a recording with three observations. We first formalize the definition of a recording by adding a prior over the starting point and then define the guided proposals again:</p><pre><code class="language-julia">recording = (
    P = P_target,
    obs = observs,
    t0 = 0.0,
    x0_prior = KnownStartingPt((@SVector [0.5 0.5])),
)
P = standard_build_guid_prop(LotkaVolterraAux, recording, tts)</code></pre><p>Because these functions have been created with the thought in mind of being able to call them repeatedly over and over again in the most efficient way we should now define a couple of containers that are needed to store intermediate states of various simulated objects. These are:</p><ul><li>A container for sampled driving Brownian motion</li><li>A container for sampled trajectory of a proposal path</li><li>A vector with flags for dimensions/shape/data type of Brownian motions</li><li>A vector of guided proposals</li></ul><p>Additionally we must provide a starting point to start sampling from, and finally, optionally, we can provide another container with a realization of a Brownian motion and a vector of hyper-parameters (each taking values <span>$\in [0,1]$</span>) for doing the preconditioned Crank-Nicolson scheme. For simplicity let&#39;s leave the last to at default values (see the source code for more info). Then, we have the following:</p><pre><code class="language-julia">WW° = map(tt-&gt;trajectory(tt, DD.ℝ{2}), tts)
XX° = deepcopy(WW°)
Wnr = [Wiener() for _=1:3]
x0 = rand(recording.x0_prior)</code></pre><p>We can now sample guided proposals with <code>forward_guide!</code>. The function will output a flag for whether the sampling has been successful (it can fail if the sampled path hits a boundary of the state space on which the process is defined) as well as the log-likelihood (due to sampled path only! in particular the contribution due to end-points is not computed and need to be computed explicitly by calling <code>loglikhd_obs</code> (though the two might be joined in the future)) that is computed alongside the sample. The sampled path is going to be saved to <code>XX°</code>.</p><pre><code class="language-julia">success, ll° = forward_guide!(WW°, XX°, Wnr, P, x0)</code></pre><p>The sampled path is stored in a vector of trajectories, so we can use a generic plotting functionality suitable for trajectories from  <a href="https://github.com/JuliaDiffusionBayes/DiffusionVis.jl">DiffusionVis.jl</a> (NOTE: not implemented).</p><p>As a side note, <code>forward_guide!</code> can also be applied directly to an interval so that sampling is done only for a single <code>GuidProp</code>, for instance, we could call:</p><pre><code class="language-julia">success_single, ll_single° = forward_guide!(WW°[1], XX°[1], Wnr[1], P[1], x0)</code></pre><h2 id="Backward-filter-1"><a class="docs-heading-anchor" href="#Backward-filter-1">Backward filter</a><a class="docs-heading-anchor-permalink" href="#Backward-filter-1" title="Permalink"></a></h2><p>A very important functionality of <code>GuidProp</code> is the ability to change the parameters of <code>GuidProp</code> without having to-reallocate almost any memory. This can be done by calling a <code>GuidProp</code> constructor that is specialized in doing such reassignment of parameters:</p><pre><code class="language-julia">θ° = ... # some new parameterization of the diffusion law
η° = ... # some new parameterization of the observation
P1_new = GuidProp(P[1], θ°, η°)</code></pre><p>Then, internally the parameters in the diffusion laws and observations are changed, but nothing is done about recomputing the guiding terms. Sometimes nothing has to be done, because the parameters have no influence on the computation of the guiding term (in which case we save some resources by avoiding expensive calls to the ODE solvers), other times, the ODE systems need to be solved anew. To re-compute the guiding term for the new parameters all we need to do is call <code>recompute_guiding_term!</code>:</p><pre><code class="language-julia">recompute_guiding_term!(P1_new)</code></pre><p><strong>NOTE</strong> that the above would not only change the guiding term of <code>P1_new</code>, but also of <code>P[1]</code>, because the constructor <code>GuidProp(P[1], θ°, η°)</code> simply re-uses the guiding term solving machinery of <code>P[1]</code>.</p><p>Now, in practice we will be working with <code>recording</code>s and not a single observation, so we will instead have:</p><pre><code class="language-julia">θ° = ... # some new parameterization of the diffusion law
ηs° = [η1°,...] # some new parameterization of the observations
P_new = map(i-&gt;GuidProp(P[i], θ°, ηs°[i]), 1:length(P))</code></pre><p>and then instead of calling <code>recompute_guiding_term!</code> we should call a <code>backward_filter!</code> (which is just a wrapper function around multiple <code>recompute_guiding_term!</code>s that work on multiple <code>GuidProp</code> stacked together).</p><pre><code class="language-julia">backward_filter!(P_new)</code></pre><p>That&#39;s it. Now, <code>P_new</code> has new parameters, has its guiding term re-computed to be compatible with those parameters and can be used for sampling.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../reparameterizations/">« Reparameterizations</a><a class="docs-footer-nextpage" href="../path_functionals/">Computing path functionals »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Thursday 14 May 2020 17:00">Thursday 14 May 2020</span>. Using Julia version 1.4.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
